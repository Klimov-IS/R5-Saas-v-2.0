# Страница «Кабинеты» (Stores)

**Дата:** 2026-02-08
**Версия:** 1.0
**URL:** `/stores`

---

## Назначение

Страница **«Кабинеты»** — центральная точка входа в систему R5.

**Роль:**
- Обзор всех подключенных магазинов Wildberries
- Агрегированная статистика по отзывам, товарам, чатам
- Управление статусом магазинов
- Навигация к детальным страницам

---

## Структура страницы

```
┌─────────────────────────────────────────────────────────────┐
│  Header: R5 Reputation Manager                              │
├─────────────────────────────────────────────────────────────┤
│  Общая статистика                                           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│  │ Магазины│ │ Отзывы  │ │ Товары  │ │  Чаты   │            │
│  │   44    │ │ 2.07M   │ │  12.5K  │ │  5.4K   │            │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘            │
├─────────────────────────────────────────────────────────────┤
│  Список магазинов                                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 🏪 Тайди Центр          1,344,055 отзывов    [→]    │   │
│  │    Status: Active       Updated: 2 hours ago         │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ 🏪 Магазин 2            250,000 отзывов      [→]    │   │
│  │    Status: Active       Updated: 3 hours ago         │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## Жизненный цикл магазина

### Статусы магазина

| Статус | Описание | CRON включен | UI |
|--------|----------|--------------|-----|
| `active` | Магазин активен, полный функционал | ✅ Да | Зеленый badge |
| `inactive` | Приостановлен, без синхронизации | ❌ Нет | Серый badge |

### Переходы статусов

```
[Новый магазин]
       ↓
   'active' ←→ 'inactive'
       ↓           ↓
   (работает)   (приостановлен)
```

**Важно:**
- CRON jobs синхронизируют **только активные** магазины
- Деактивация не удаляет данные, только приостанавливает синхронизацию
- Реактивация возобновляет синхронизацию со следующего цикла

---

## Агрегированные данные

### На уровне страницы (общая статистика)

| Метрика | Источник | Обновление |
|---------|----------|------------|
| Всего магазинов | `COUNT(stores)` | Realtime |
| Всего отзывов | `SUM(stores.total_reviews)` | После каждого sync |
| Активных товаров | `COUNT(products WHERE is_active)` | После product sync |
| Всего чатов | `SUM(stores.total_chats)` | После dialogue sync |

### На уровне магазина (карточка)

| Поле | Описание | Поле в БД |
|------|----------|-----------|
| Название | Имя магазина | `stores.name` |
| Статус | active/inactive | `stores.status` |
| Отзывов | Кешированный счётчик | `stores.total_reviews` |
| Чатов | Кешированный счётчик | `stores.total_chats` |
| Последняя синхронизация | Дата последнего sync | `stores.last_review_update_date` |
| Статус синхронизации | success/error | `stores.last_review_update_status` |

---

## Ключевые действия

### 1. Просмотр списка магазинов

**Endpoint:** `GET /api/stores`

**Фильтры:**
- По статусу (active/inactive)
- По имени (поиск)

### 2. Переход в магазин

Клик по карточке → переход на `/stores/[storeId]/products`

### 3. Создание нового магазина

**Endpoint:** `POST /api/stores`

**Требуемые данные:**
- Название магазина
- WB API токен (api_token)

**После создания:**
1. Магазин получает статус `active`
2. Автоматически запускается синхронизация товаров
3. По расписанию — синхронизация отзывов и чатов

### 4. Деактивация магазина

**Endpoint:** `PATCH /api/stores/[storeId]/status`

**Эффект:**
- Магазин исключается из CRON jobs
- Данные сохраняются
- Можно реактивировать

### 5. Удаление магазина

**Endpoint:** `DELETE /api/stores/[storeId]`

**Эффект (CASCADE):**
- Удаляются все товары
- Удаляются все отзывы
- Удаляются все жалобы
- Удаляются все чаты

**Требует подтверждения в UI.**

---

## Триггеры и автоматизация

### При создании магазина

1. Генерируется уникальный ID
2. Устанавливается `status = 'active'`
3. Создаётся запись в `stores`
4. Вызывается `/api/stores/[storeId]/products/update`

### При синхронизации (CRON)

**Hourly Review Sync:**
1. Получить все `active` магазины
2. Для каждого вызвать incremental sync
3. Обновить `total_reviews`
4. Сгенерировать жалобы для новых отзывов

**Daily Product Sync:**
1. Получить все `active` магазины
2. Синхронизировать товары с WB Content API
3. Обновить `is_active` флаги

**Adaptive Dialogue Sync:**
1. Получить все `active` магазины
2. Синхронизировать чаты
3. Обновить `total_chats`

---

## Связь с другими сущностями

```
stores (1) ────→ (N) products
              ↳ (N) reviews ────→ (1) review_complaints
              ↳ (N) chats ────→ (N) chat_messages
              ↳ (N) questions
```

---

## API Endpoints

| Метод | Endpoint | Назначение |
|-------|----------|------------|
| GET | `/api/stores` | Список магазинов |
| POST | `/api/stores` | Создать магазин |
| GET | `/api/stores/:id` | Детали магазина |
| PATCH | `/api/stores/:id` | Обновить магазин |
| DELETE | `/api/stores/:id` | Удалить магазин |
| PATCH | `/api/stores/:id/status` | Изменить статус |

**Подробнее:** [API Reference](../reference/api.md)

---

## UI Компоненты

### StoreCard

Карточка магазина в списке.

**Отображает:**
- Иконка + название
- Статус badge (зеленый/серый)
- Счётчики (отзывы, чаты)
- Время последней синхронизации
- Статус синхронизации (success/error индикатор)

### StoreStats

Общая статистика всех магазинов.

**Метрики:**
- Total stores
- Total reviews
- Total products
- Total chats

### CreateStoreModal

Модальное окно создания магазина.

**Поля:**
- Название (text input)
- WB API Token (password input)
- Опционально: Content API Token, Chat API Token

---

## Права доступа

| Действие | Владелец | Менеджер |
|----------|----------|----------|
| Просмотр списка | ✅ | ✅ (только свои) |
| Создание | ✅ | ❌ |
| Редактирование | ✅ | ❌ |
| Удаление | ✅ | ❌ |
| Деактивация | ✅ | ❌ |

---

## Связанные документы

- [Табы кабинета клиента](./client-tabs.md)
- [Database Schema](../database-schema.md)
- [CRON Jobs](../CRON_JOBS.md)
- [API Reference](../reference/api.md)

---

**Last Updated:** 2026-02-08
