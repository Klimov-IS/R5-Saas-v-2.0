# –¢–∞–±—ã –∫–∞–±–∏–Ω–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞

**–î–∞—Ç–∞:** 2026-02-08
**–í–µ—Ä—Å–∏—è:** 1.0
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Anti-overanalysis –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç–∞–±–æ–≤

---

## –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ **–∫–∞–±–∏–Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞** —Å —Ç—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–∞–±–∞–º–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üè™ –¢–∞–π–¥–∏ –¶–µ–Ω—Ç—Ä                                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–¢–æ–≤–∞—Ä—ã]    [–û—Ç–∑—ã–≤—ã]    [–ß–∞—Ç—ã]                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ               –ö–æ–Ω—Ç–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**URL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `/stores/[storeId]/products` ‚Äî –¢–æ–≤–∞—Ä—ã
- `/stores/[storeId]/reviews` ‚Äî –û—Ç–∑—ã–≤—ã
- `/stores/[storeId]/chats` ‚Äî –ß–∞—Ç—ã

---

## 1. –¢–∞–± ¬´–¢–æ–≤–∞—Ä—ã¬ª (Products)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–º —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

### –î–∞–Ω–Ω—ã–µ

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `products` + `product_rules`

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `name` | text | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ |
| `wb_product_id` | text | WB nmId |
| `vendor_code` | text | –ê—Ä—Ç–∏–∫—É–ª |
| `price` | integer | –¶–µ–Ω–∞ (–∫–æ–ø–µ–π–∫–∏) |
| `image_url` | text | –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ |
| `review_count` | integer | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ |
| `is_active` | boolean | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä |
| `work_status` | enum | –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã (not_working/active/paused/completed) |

**Product Rules:**

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `submit_complaints` | –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∂–∞–ª–æ–±—ã |
| `complaint_rating_1..4` | –ù–∞ –∫–∞–∫–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –∂–∞–ª–æ–≤–∞—Ç—å—Å—è |
| `work_in_chats` | –†–∞–±–æ—Ç–∞—Ç—å –≤ —á–∞—Ç–∞—Ö |
| `chat_rating_1..4` | –ù–∞ –∫–∞–∫–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —á–∞—Ç–∞—Ö |
| `chat_strategy` | –°—Ç—Ä–∞—Ç–µ–≥–∏—è (upgrade_to_5/delete/both) |
| `offer_compensation` | –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é |

### –§–∏–ª—å—Ç—Ä—ã

| –§–∏–ª—å—Ç—Ä | –ü–∞—Ä–∞–º–µ—Ç—Ä API | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------------|----------|
| –ü–æ —Å—Ç–∞—Ç—É—Å—É | `is_active` | –ê–∫—Ç–∏–≤–Ω—ã–µ / –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ |
| –ü–æ work_status | `work_status` | not_working, active, paused, completed |
| –ü–æ–∏—Å–∫ | `search` | –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É |

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**Endpoint:** `GET /api/stores/[storeId]/products`

**Query params:**
```
?skip=0&take=50&is_active=true&work_status=active&search=...
```

**–ü–∞–≥–∏–Ω–∞—Ü–∏—è:** Infinite scroll / Load more

### –î–µ–π—Å—Ç–≤–∏—è

| –î–µ–π—Å—Ç–≤–∏–µ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | `POST /products/update` | –û–±–Ω–æ–≤–∏—Ç—å –∏–∑ WB |
| –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å | `PATCH /products/:id/status` | –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å |
| –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ | `PUT /products/:id/rules` | –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ |
| Bulk actions | `POST /products/bulk-actions` | –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è |

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

**–ö–æ–≥–¥–∞ `is_active = true` + `work_status = 'active'`:**
1. –ñ–∞–ª–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
2. –¢–æ–≤–∞—Ä –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ backfill –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
3. CRON —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ö–æ–≥–¥–∞ `is_active = false`:**
- –ñ–∞–ª–æ–±—ã –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è
- –û—Ç–∑—ã–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è (–Ω–æ –±–µ–∑ –∂–∞–ª–æ–±)

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

```
[–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω –∏–∑ WB sync]
       ‚Üì
is_active = true (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
work_status = 'not_working'
       ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∞–µ—Ç submit_complaints]
       ‚Üì
work_status = 'active'
       ‚Üì
[–°–æ–∑–¥–∞—ë—Ç—Å—è backfill job]
       ‚Üì
[Backfill –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∂–∞–ª–æ–±—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–æ–≤]
       ‚Üì
[CRON –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∂–∞–ª–æ–±—ã –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤]
```

---

## 2. –¢–∞–± ¬´–û—Ç–∑—ã–≤—ã¬ª (Reviews)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã.

### –î–∞–Ω–Ω—ã–µ

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `reviews` + `review_complaints`

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –æ—Ç–∑—ã–≤–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `rating` | 1-5 | –†–µ–π—Ç–∏–Ω–≥ |
| `text` | text | –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ |
| `pros` | text | –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ |
| `cons` | text | –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ |
| `author` | text | –ê–≤—Ç–æ—Ä |
| `date` | timestamp | –î–∞—Ç–∞ |
| `answer` | jsonb | –û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ |
| `photo_links` | jsonb | –§–æ—Ç–æ |

**–°—Ç–∞—Ç—É—Å—ã:**

| –ü–æ–ª–µ | –¢–∏–ø | –ó–Ω–∞—á–µ–Ω–∏—è |
|------|-----|----------|
| `complaint_status` | enum | not_sent, draft, pending, approved, rejected |
| `review_status_wb` | enum | visible, unpublished, excluded, unknown |
| `product_status_by_review` | enum | purchased, refused, not_specified, unknown |

**–î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏:**

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `has_complaint` | –ï—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∂–∞–ª–æ–±–∞ |
| `has_complaint_draft` | –ï—Å—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –∂–∞–ª–æ–±—ã |
| `has_answer` | –ï—Å—Ç—å –æ—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ |
| `is_product_active` | –¢–æ–≤–∞—Ä –∞–∫—Ç–∏–≤–µ–Ω |

### –§–∏–ª—å—Ç—Ä—ã

| –§–∏–ª—å—Ç—Ä | –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| –†–µ–π—Ç–∏–Ω–≥ | `rating` | 1, 2, 3, 4, 5 –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω |
| –°—Ç–∞—Ç—É—Å –∂–∞–ª–æ–±—ã | `complaint_status` | not_sent, draft, sent, pending, approved, rejected |
| –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ | `is_product_active` | true/false |
| –î–∞—Ç–∞ | `dateFrom`, `dateTo` | –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç |
| –ï—Å—Ç—å –æ—Ç–≤–µ—Ç | `has_answer` | true/false |
| –°—Ç–∞—Ç—É—Å WB | `review_status_wb` | visible, unpublished, excluded |
| –ü–æ–∏—Å–∫ | `search` | –ü–æ —Ç–µ–∫—Å—Ç—É, –∞–≤—Ç–æ—Ä—É |

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**Endpoint:** `GET /api/stores/[storeId]/reviews`

**Query params:**
```
?skip=0&take=50&rating=1,2,3&complaint_status=not_sent&is_product_active=true
```

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:** –ü–æ –¥–∞—Ç–µ (DESC) ‚Äî —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ

### –î–µ–π—Å—Ç–≤–∏—è

| –î–µ–π—Å—Ç–≤–∏–µ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | `POST /reviews/update` | mode=incremental/full |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±—ã | `POST /reviews/:id/generate-complaint` | AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è |
| –û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π | `PUT /reviews/:id/complaint/sent` | –ß–µ—Ä–µ–∑ Extension |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ | `POST /reviews/:id/generate-reply` | AI –æ—Ç–≤–µ—Ç |
| –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç | `POST /reviews/:id/send` | –í WB |

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

**CRON (hourly-review-sync):**
1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã
2. –î–ª—è –æ—Ç–∑—ã–≤–æ–≤ —Å rating ‚â§ 4 + is_product_active = true
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∂–∞–ª–æ–±—ã (draft)

**Backfill Worker:**
1. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å backfill
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∂–∞–ª–æ–±—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–æ–≤
3. –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ submit_complaints –Ω–∞ —Ç–æ–≤–∞—Ä–µ

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∂–∞–ª–æ–±

```
[–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ —Å rating ‚â§ 4]
       ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∞: is_product_active = true?]
       ‚Üì YES
[–ü—Ä–æ–≤–µ—Ä–∫–∞: product_rules.submit_complaints = true?]
       ‚Üì YES
[–ü—Ä–æ–≤–µ—Ä–∫–∞: complaint_rating_X = true? (X = rating)]
       ‚Üì YES
[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±—ã]
       ‚Üì
complaint_status = 'draft'
       ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Extension]
       ‚Üì
complaint_status = 'pending'
       ‚Üì
[WB –º–æ–¥–µ—Ä–∏—Ä—É–µ—Ç]
       ‚Üì
complaint_status = 'approved' | 'rejected'
```

### UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **ReviewCard** ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–∑—ã–≤–∞
- **ComplaintBadge** ‚Äî —Å—Ç–∞—Ç—É—Å –∂–∞–ª–æ–±—ã
- **FilterPanel** ‚Äî –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤
- **BulkActions** ‚Äî –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

---

## 3. –¢–∞–± ¬´–ß–∞—Ç—ã¬ª (Chats)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–†–∞–±–æ—Ç–∞ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è.

### –†–µ–∂–∏–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

1. **Table View** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Ç–æ–≤
2. **Messenger View** ‚Äî split-view (—Å–ø–∏—Å–æ–∫ + –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç)

### –î–∞–Ω–Ω—ã–µ

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `chats` + `chat_messages`

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è —á–∞—Ç–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `client_name` | text | –ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è |
| `product_nm_id` | text | –¢–æ–≤–∞—Ä (nmId) |
| `product_name` | text | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ |
| `last_message_date` | timestamp | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `last_message_text` | text | –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `last_message_sender` | text | client/seller |
| `tag` | text | –¢–µ–≥ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
| `draft_reply` | text | –ß–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞ |

**–¢–µ–≥–∏ —á–∞—Ç–æ–≤:**

| –¢–µ–≥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `untagged` | –ù–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω |
| `active` | –ê–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ |
| `no_reply` | –ë–µ–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è |
| `completed` | –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π |
| `negative` | –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π |
| `positive` | –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π |
| `question` | –í–æ–ø—Ä–æ—Å |

### –§–∏–ª—å—Ç—Ä—ã

| –§–∏–ª—å—Ç—Ä | –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| –ü–æ —Ç–µ–≥—É | `tag` | active, no_reply, completed, etc. |
| –ü–æ –¥–∞—Ç–µ | `dateFrom`, `dateTo` | –ü–µ—Ä–∏–æ–¥ |
| –ü–æ–∏—Å–∫ | `search` | –ü–æ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞, —Ç–æ–≤–∞—Ä—É, —Ç–µ–∫—Å—Ç—É |

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**Endpoint:** `GET /api/stores/[storeId]/chats`

**Query params:**
```
?skip=0&take=100&tag=active&search=...
```

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:** –ü–æ last_message_date DESC

### –î–µ–π—Å—Ç–≤–∏—è

| –î–µ–π—Å—Ç–≤–∏–µ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | `POST /dialogues/update` | –ò–∑ WB Chat API |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ | `POST /chats/:id/generate-ai` | AI –æ—Ç–≤–µ—Ç |
| –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ | `POST /chats/:id/send` | –í WB |
| –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–≥ | `PATCH /chats/:id/status` | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è |
| –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ | `POST /chats/classify-all` | AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è |
| Bulk send | `POST /chats/bulk/send` | –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ |
| Bulk generate | `POST /chats/bulk/generate-ai` | –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è |

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

**Adaptive Dialogue Sync:**
- –î–µ–Ω—å (06:00-21:00 MSK): –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
- –ù–æ—á—å (21:00-06:00 MSK): –∫–∞–∂–¥—ã–µ 60 –º–∏–Ω—É—Ç

**AI –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- –†—É—á–Ω–∞—è —á–µ—Ä–µ–∑ `POST /chats/classify-all`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

```
[–ù–æ–≤—ã–π —á–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–∑ WB]
       ‚Üì
tag = 'untagged'
       ‚Üì
[AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä]
       ‚Üì
tag = 'active' | 'negative' | 'question' | ...
       ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI"]
       ‚Üì
[generateChatReply() flow]
       ‚Üì
draft_reply = AI —Ç–µ–∫—Å—Ç
       ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)]
       ‚Üì
[–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ WB]
       ‚Üì
[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ chat_messages]
       ‚Üì
tag = 'completed' (–µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç)
```

### UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**Table View:**
- **ChatTable** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Ç–æ–≤
- **ChatRow** ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å —á–∞—Ç–æ–º

**Messenger View:**
- **ChatList** ‚Äî –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º
- **ChatWindow** ‚Äî –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π
- **MessageBubble** ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ
- **AISuggestionBox** ‚Äî AI –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
- **MessageComposer** ‚Äî –ø–æ–ª–µ –≤–≤–æ–¥–∞

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ê—Å–ø–µ–∫—Ç | –¢–æ–≤–∞—Ä—ã | –û—Ç–∑—ã–≤—ã | –ß–∞—Ç—ã |
|--------|--------|--------|------|
| **–ò—Å—Ç–æ—á–Ω–∏–∫** | WB Content API | WB Feedbacks API | WB Chat API |
| **–ß–∞—Å—Ç–æ—Ç–∞ sync** | 1 —Ä–∞–∑/–¥–µ–Ω—å | –ö–∞–∂–¥—ã–π —á–∞—Å | 15/60 –º–∏–Ω |
| **AI —Ñ—É–Ω–∫—Ü–∏–∏** | –ù–µ—Ç | –ñ–∞–ª–æ–±—ã, –æ—Ç–≤–µ—Ç—ã | –û—Ç–≤–µ—Ç—ã, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è |
| **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** | Backfill queue | Hourly complaints | Adaptive sync |
| **–ö–ª—é—á–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä** | is_active, work_status | rating, complaint_status | tag |

---

## –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ç–∞–±–∞–º–∏

### –ò–∑ –¢–æ–≤–∞—Ä–æ–≤ –≤ –û—Ç–∑—ã–≤—ã

–ö–ª–∏–∫ –Ω–∞ —Ç–æ–≤–∞—Ä ‚Üí –û—Ç–∑—ã–≤—ã —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `product_id`

### –ò–∑ –û—Ç–∑—ã–≤–æ–≤ –≤ –ß–∞—Ç—ã

–ï—Å–ª–∏ `chat_status_by_review = 'available'`:
- –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"
- –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ß–∞—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Ç–æ–≤–∞—Ä—É

### –ò–∑ –ß–∞—Ç–æ–≤ –≤ –û—Ç–∑—ã–≤—ã

–ü–æ `product_nm_id` ‚Üí –û—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞

---

## –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**React Query:**

| –î–∞–Ω–Ω—ã–µ | staleTime | cacheTime |
|--------|-----------|-----------|
| Products list | 5 min | 30 min |
| Reviews list | 2 min | 10 min |
| Chats list | 1 min | 5 min |
| Single review | 1 min | 10 min |
| Chat history | 30 sec | 5 min |

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü–æ—Å–ª–µ sync –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (mutate)
- –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `/api/cache/invalidate`

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ö–∞–±–∏–Ω–µ—Ç—ã](./cabinets.md)
- [–õ–æ–≥–∏–∫–∞ –∂–∞–ª–æ–±](../domains/complaints.md)
- [AI –≤ —á–∞—Ç–∞—Ö](../domains/chats-ai.md)
- [API Reference](../reference/api.md)
- [Database Schema](../database-schema.md)
- [–§–∏–ª—å—Ç—Ä—ã](../FILTERS_SYSTEM.md)

---

**Last Updated:** 2026-02-08
