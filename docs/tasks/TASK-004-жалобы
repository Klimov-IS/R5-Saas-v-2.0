# TASK — Complaints Generation Audit & Auto-Backfill (R5)

## Контекст проекта

R5 — сервис управления репутацией продавцов на маркетплейсах.  
Одна из ключевых функций — **автоматическая генерация жалоб на отзывы** по заданным правилам (звёздность, лимиты, тексты, шаблоны).

На текущем этапе необходимо:
- провести **полный аудит существующей логики генерации жалоб**
- выявить **несоответствия правилам (в т.ч. лимит 1000 символов)**
- спроектировать и подготовить **новую автоматизацию “массовой догенерации” жалоб при активации товара**
- подготовить **продуктовый отчёт + план улучшений**

Cloud Code должен действовать **как Product Manager / System Analyst**, а не как “исполнитель кода”.

---

## Цели задачи (Goals)

1. Полностью **разобраться в текущей архитектуре генерации жалоб**
2. Зафиксировать:
   - где и как создаются жалобы
   - какие правила и ограничения применяются
   - какие данные участвуют в промптах
3. Выявить **технические и продуктовые проблемы**
4. Спроектировать **новую автоматизацию массовой генерации жалоб**
5. Подготовить **SQL-анализ черновиков с превышением 1000 символов**
6. Сформировать **план улучшений + backlog**

---

## Область анализа (Scope)

### 1. Аудит текущей логики генерации жалоб

#### 1.1 Точки генерации
- Cron Jobs (все связанные)
- Ручные триггеры
- Автоматизации, связанные с:
  - отзывами
  - кабинетами
  - товарами
  - правилами

#### 1.2 Логика генерации
- Когда именно создаётся жалоба
- Какие условия обязательны
- Что является триггером (новый отзыв / статус / правило)
- Есть ли повторная генерация
- Есть ли защита от дублей

#### 1.3 Ограничения
- лимиты по:
  - количеству жалоб
  - времени
  - символам (1000)
- где именно они проверяются:
  - до генерации
  - после генерации
  - отсутствуют

---

### 2. Анализ промптов и данных

- Какие данные входят в промпт:
  - текст отзыва
  - рейтинг
  - товар
  - правила клиента
  - шаблоны
- Где хранятся промпты
- Есть ли:
  - версии промптов
  - fallback-логика
  - пост-валидация результата

**Отдельно:**  
Проанализировать, **почему в БД присутствуют жалобы >1000 символов**:
- отсутствует проверка?
- проверка реализована не во всех местах?
- ручная генерация?
- legacy-код?

---

### 3. Раздел «Отзывы» (Reviews Page)

Проанализировать:
- Как отображаются отзывы
- Какие статусы есть у отзывов и жалоб
- Где происходит переход:
  - отзыв → жалоба
  - смена статусов
- Какие правила применяются:
  - 1★ / 2★ / 3★
  - активность / неактивность

---

## Новая автоматизация: Auto Backfill жалоб

### Проблема

- При активации товара **не происходит массовая генерация жалоб**
- Старые отзывы остаются необработанными
- Генерация происходит фрагментарно

---

### Требуемое поведение (Target Behavior)

При **активации товара** в разделе «Товары»:

1. Проверяются правила жалоб:
   - по звёздам (1★ / 2★ / 3★)
   - `is_active = true`
2. Система:
   - выбирает все отзывы, подпадающие под правила
   - запускает **пакетную генерацию жалоб**
3. Ограничение:
   - **не более 2000 жалоб в сутки**
4. Если отзывов больше лимита:
   - генерация продолжается на следующий день
   - до полного исчерпания
5. Генерация должна быть:
   - идемпотентной
   - без дублей
   - с прозрачным логированием

---

### Что нужно спроектировать

- Архитектура:
  - batch / очередь / worker
  - cron / scheduler
- Хранилище прогресса:
  - сколько обработано
  - сколько осталось
  - дата последнего запуска
- Fail-safe:
  - восстановление после падений
  - защита от повторной генерации
- Метрики:
  - создано жалоб
  - осталось
  - прогноз по времени завершения

---

## Анализ БД: жалобы > 1000 символов

### Задача

1. Подготовить SQL-запрос (read-only):
   - все жалобы / черновики
   - `length(text) > 1000`
2. Агрегации:
   - по клиенту
   - по кабинету
   - по дате
3. Метрики:
   - общее количество
   - процент от всех жалоб

### Результат

- Табличный отчёт
- Выводы:
  - критичность
  - возможные причины
- Подготовка **отдельной задачи**:
  - удаление / регенерация
  - **только после ручного согласования**

---

## Формат итогового отчёта (обязателен)

1. Executive Summary
2. Current State (как работает сейчас)
3. Issues & Risks
4. Proposed Improvements
5. New Automation Design
6. Backlog:
   - MVP
   - Phase 2
   - Phase 3

---

## Ограничения и правила

- ❌ Не писать код
- ❌ Не изменять данные
- ✅ Только анализ и SQL-read-only
- ✅ Все допущения явно помечать
- ✅ При нехватке данных — задавать вопросы

---

## Definition of Done (DoD)

- Полный аудит логики генерации
- Спроектирована авто-догенерация
- Есть SQL-анализ >1000 символов
- Сформирован backlog
- Нет неописанных зон

---

## Следующий шаг

После принятия отчёта:
1. Утверждение логики auto-backfill
2. Решение по жалобам >1000 символов
3. Декомпозиция в спринты
4. Передача в разработку
