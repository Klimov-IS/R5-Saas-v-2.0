# TASK-001: Ротационная полная синхронизация отзывов

**Статус:** Запланировано
**Приоритет:** Средний
**Создано:** 2026-02-02

---

## Проблема

Инкрементальная синхронизация (каждые 15 мин) иногда пропускает отзывы:
- WB API баги — не всегда возвращает все записи
- Таймауты — при ошибке запроса данные теряются
- Изменённые отзывы — если WB обновил старый отзыв, мы его не увидим
- Пагинация — при большом объёме можем не дойти до конца

---

## Решение: Ротация по периодам

Вместо одной большой полной синхронизации — разбить на периоды по дням недели:

```
День 1 (Вс): 0-90 дней назад     (свежие)
День 2 (Пн): 0-90 дней назад     (свежие — чаще)
День 3 (Вт): 90-180 дней назад
День 4 (Ср): 180-270 дней назад
День 5 (Чт): 270-365 дней назад
День 6 (Пт): 365-730 дней назад  (1-2 года)
День 7 (Сб): 730+ дней назад     (архив)
```

### Плюсы
- Нагрузка распределена равномерно
- За 7 дней покрываем ВСЮ историю
- Свежие данные синхронизируются чаще (2 раза в неделю)
- Нет риска таймаутов

---

## Техническая реализация

### 1. Добавить параметры в существующий sync

Файл: `src/app/api/stores/[storeId]/reviews/update/route.ts`

```typescript
// Новые параметры для ротации
interface RotatingSyncParams {
  daysFrom: number;  // Начало периода (дней назад)
  daysTo: number;    // Конец периода (дней назад)
}

// Пример: синхронизация за 90-180 дней назад
// daysFrom=90, daysTo=180
```

### 2. Новый CRON job

Файл: `src/lib/cron-jobs.ts`

```typescript
// Расписание: каждый день в 03:00 MSK
cron.schedule('0 0 * * *', async () => {
  const dayOfWeek = new Date().getDay(); // 0-6

  const periods = [
    { from: 0, to: 90 },      // Вс: свежие
    { from: 0, to: 90 },      // Пн: свежие (чаще)
    { from: 90, to: 180 },    // Вт
    { from: 180, to: 270 },   // Ср
    { from: 270, to: 365 },   // Чт
    { from: 365, to: 730 },   // Пт
    { from: 730, to: 1825 },  // Сб: до 5 лет
  ];

  const period = periods[dayOfWeek];

  // Запустить rotating sync для всех активных магазинов
  await runRotatingSyncForAllStores(period);
});
```

### 3. API endpoint (опционально)

```
POST /api/cron/rotating-sync?daysFrom=90&daysTo=180
```

Для ручного запуска и тестирования.

---

## Оценка нагрузки

| Параметр | На 1 магазин | На 46 магазинов |
|----------|--------------|-----------------|
| Время sync (90 дней) | 1-3 мин | 45-140 мин |
| WB API запросов | ~10-20 | ~500-1000 |
| Нагрузка на БД | Низкая | Умеренная |
| RAM пиково | ~100 MB | ~200-500 MB |

**Рекомендации:**
- Запускать ночью (03:00 MSK)
- Задержка между магазинами: 5-10 сек
- Последовательная обработка (не параллельно)

---

## Существующий код для переиспользования

Уже реализовано в `reviews/update/route.ts`:
- `generateInitialDateChunks()` — генерация чанков по датам
- `splitChunk()` — адаптивное разбиение больших чанков
- Full sync с параметрами `dateFrom`/`dateTo`
- Rate limiting (10 сек между чанками)

---

## Чеклист реализации

- [ ] Добавить параметры `daysFrom`/`daysTo` в refresh функцию
- [ ] Создать новый CRON job с ротацией по дням недели
- [ ] Добавить логирование периода синхронизации
- [ ] Добавить метрики (сколько новых/обновлённых отзывов найдено)
- [ ] Тестирование на одном магазине
- [ ] Деплой и мониторинг

---

## Связанные файлы

- `src/app/api/stores/[storeId]/reviews/update/route.ts` — основная логика sync
- `src/lib/cron-jobs.ts` — CRON jobs
- `src/db/helpers.ts` — `upsertReview()`
