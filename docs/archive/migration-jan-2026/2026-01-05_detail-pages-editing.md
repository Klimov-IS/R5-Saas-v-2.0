# Feature: Детальные страницы отзывов/чатов + Управление магазинами

## 1. Цель

Добавить возможность работы с конкретным отзывом/чатом и полноценное управление магазинами.

**Проблема:**
- Пользователь видит списки отзывов и чатов, но не может с ними взаимодействовать
- Нет возможности отвечать на отзывы через UI
- Нет возможности отправлять сообщения в чаты
- Кнопка "Добавить магазин" не работает
- Нет возможности редактировать/удалять магазины

**Решение:**
- Детальные страницы для просмотра и редактирования отзывов
- Детальные страницы для просмотра чатов и отправки сообщений
- Форма добавления нового магазина
- Управление существующими магазинами

---

## 2. Текущее Состояние

### Отзывы
- ✅ Список отзывов с пагинацией и фильтрами
- ❌ Нет возможности открыть детали отзыва
- ❌ Нет возможности написать ответ
- ❌ Нет сохранения черновика

### Чаты
- ✅ Список чатов с пагинацией и фильтрами
- ✅ Классификация чатов через AI
- ❌ Нет возможности открыть полный диалог
- ❌ Нет возможности отправить сообщение
- ❌ Нет возможности изменить тег вручную

### Магазины
- ✅ Список магазинов на главной странице
- ❌ Кнопка "Добавить магазин" не работает
- ❌ Нет формы для добавления
- ❌ Нет редактирования/удаления
- ❌ Нет toggle "Авто-рассылка"

---

## 3. Предлагаемые Изменения

### 3.1 Детальная страница отзыва

**Новый файл:** `src/app/stores/[storeId]/reviews/[reviewId]/page.tsx`

**Функционал:**
- Отображение полной информации об отзыве:
  - Рейтинг (1-5 звёзд)
  - Текст отзыва
  - Плюсы
  - Минусы
  - Автор
  - Дата создания
  - Артикул товара
  - Название товара
- Текущий ответ (если есть)
- Поле для написания/редактирования черновика ответа (Textarea)
- Кнопки:
  - "Сохранить черновик" → сохраняет в БД, не отправляет на WB
  - "Отправить ответ" → отправляет на WB через API
  - "Назад к списку"
- Loading states для всех операций
- Toast уведомления об успехе/ошибке

**API endpoints:**
- `GET /api/stores/[storeId]/reviews/[reviewId]` - получить детали отзыва
- `PUT /api/stores/[storeId]/reviews/[reviewId]` - сохранить черновик
- `POST /api/stores/[storeId]/reviews/[reviewId]/send` - отправить ответ на WB

### 3.2 Детальная страница чата

**Новый файл:** `src/app/stores/[storeId]/chats/[chatId]/page.tsx`

**Функционал:**
- Отображение полной истории диалога:
  - Все сообщения в хронологическом порядке
  - Разделение на сообщения клиента / продавца
  - Timestamp каждого сообщения
  - Скролл вниз к последнему сообщению
- Информация о чате:
  - ID чата
  - Имя клиента
  - Товар (если указан)
  - Текущий тег
- Select для изменения тега вручную
- Поле для написания нового сообщения (Textarea)
- Кнопки:
  - "Отправить" → отправляет сообщение на WB
  - "Назад к списку"
- Loading states
- Toast уведомления

**API endpoints:**
- `GET /api/stores/[storeId]/chats/[chatId]` - получить полный диалог
- `POST /api/stores/[storeId]/chats/[chatId]/send` - отправить сообщение
- `PUT /api/stores/[storeId]/chats/[chatId]` - обновить тег

### 3.3 Управление магазинами

**Новый файл:** `src/app/stores/new/page.tsx`

**Функционал:**
- Форма добавления нового магазина:
  - Название магазина (Input)
  - API ключ WB (Input, type=password)
  - Опционально: Content API ключ
  - Опционально: Feedbacks API ключ
  - Опционально: Chat API ключ
- Валидация:
  - Проверка формата ключа
  - Проверка что ключ действителен (тестовый запрос к WB API)
- Кнопки:
  - "Добавить магазин" → создаёт запись в БД
  - "Отмена" → возврат на главную

**API endpoint:**
- `POST /api/stores` - создать новый магазин

**Обновить файл:** `src/app/page.tsx`
- Активировать кнопку "Добавить магазин" → переход на `/stores/new`
- Добавить кнопки редактирования/удаления для каждого магазина в списке
- Добавить колонку "Авто-рассылка" с Switch

**API endpoints:**
- `PUT /api/stores/[storeId]` - обновить магазин
- `DELETE /api/stores/[storeId]` - удалить магазин

---

## 4. Технический План

### Шаг 1: Обновить списки (добавить навигацию) - 30 минут
**Файлы:**
- `src/app/stores/[storeId]/reviews/page.tsx`
  - Сделать строку таблицы кликабельной
  - При клике → `router.push(`/stores/${storeId}/reviews/${review.id}`)`

- `src/app/stores/[storeId]/chats/page.tsx`
  - Аналогично для чатов

### Шаг 2: Детальная страница отзыва - 3-4 часа
**Создать:**
- `src/app/stores/[storeId]/reviews/[reviewId]/page.tsx`
- `src/app/api/stores/[storeId]/reviews/[reviewId]/route.ts` (GET, PUT)
- `src/app/api/stores/[storeId]/reviews/[reviewId]/send/route.ts` (POST)

**Database helpers:**
- `getReviewById(reviewId)` - получить отзыв по ID
- `updateReviewDraft(reviewId, draftReply)` - сохранить черновик
- `sendReviewReply(reviewId, reply)` - отметить что ответ отправлен

**WB API Integration:**
- Реализовать отправку ответа через WB Feedbacks API
- Обработка ошибок API

### Шаг 3: Детальная страница чата - 4-5 часов
**Создать:**
- `src/app/stores/[storeId]/chats/[chatId]/page.tsx`
- `src/app/api/stores/[storeId]/chats/[chatId]/route.ts` (GET, PUT)
- `src/app/api/stores/[storeId]/chats/[chatId]/send/route.ts` (POST)

**Database helpers:**
- `getChatById(chatId)` - получить чат со всеми сообщениями
- `getChatMessages(chatId)` - получить историю сообщений
- `updateChatTag(chatId, tag)` - обновить тег
- `sendChatMessage(chatId, message)` - добавить сообщение

**WB API Integration:**
- Реализовать отправку сообщения через WB Chat API
- Синхронизация после отправки

### Шаг 4: Управление магазинами - 2-3 часа
**Создать:**
- `src/app/stores/new/page.tsx`
- `src/app/api/stores/route.ts` (POST - уже есть, проверить)
- `src/app/api/stores/[storeId]/route.ts` (PUT, DELETE)

**Обновить:**
- `src/app/page.tsx`
  - Активировать кнопку "Добавить магазин"
  - Добавить кнопки Edit/Delete
  - Добавить Switch для авто-рассылки

**Database helpers:**
- `createStore(data)` - создать магазин
- `updateStore(storeId, data)` - обновить магазин
- `deleteStore(storeId)` - удалить магазин

**Валидация:**
- Проверка WB API ключа через тестовый запрос

---

## 5. Sprint Breakdown

### Sprint 6.2.1: Навигация к деталям (30 минут)
- [ ] Обновить reviews/page.tsx - добавить onClick → navigate
- [ ] Обновить chats/page.tsx - добавить onClick → navigate

### Sprint 6.2.2: Детальная страница отзыва (3-4 часа)
- [ ] Создать page.tsx для детальной страницы
- [ ] Создать API route GET /reviews/[reviewId]
- [ ] Создать API route PUT /reviews/[reviewId] (сохранить черновик)
- [ ] Создать API route POST /reviews/[reviewId]/send (отправить на WB)
- [ ] Реализовать DB helpers
- [ ] Интеграция с WB Feedbacks API
- [ ] UI с формой и кнопками
- [ ] Тестирование

### Sprint 6.2.3: Детальная страница чата (4-5 часов)
- [ ] Создать page.tsx для детальной страницы чата
- [ ] Создать API route GET /chats/[chatId]
- [ ] Создать API route PUT /chats/[chatId] (обновить тег)
- [ ] Создать API route POST /chats/[chatId]/send (отправить сообщение)
- [ ] Реализовать DB helpers
- [ ] Интеграция с WB Chat API
- [ ] UI с историей сообщений и формой
- [ ] Тестирование

### Sprint 6.2.4: Управление магазинами (2-3 часа)
- [ ] Создать page.tsx для формы "Добавить магазин"
- [ ] Создать API route POST /stores
- [ ] Создать API route PUT /stores/[storeId]
- [ ] Создать API route DELETE /stores/[storeId]
- [ ] Обновить главную страницу (кнопки Edit/Delete, Switch)
- [ ] Валидация WB API ключа
- [ ] Тестирование

---

## 6. Риски & Edge Cases

### Риск 1: WB API может вернуть ошибку при отправке ответа
**Решение:**
- Обработка всех ошибок API
- Показ понятного сообщения пользователю
- Сохранение попытки в логи

### Риск 2: Пользователь может случайно отправить некорректный ответ
**Решение:**
- Подтверждение перед отправкой (диалог "Вы уверены?")
- Предпросмотр ответа перед отправкой

### Риск 3: Удаление магазина с данными
**Решение:**
- Подтверждение удаления с предупреждением
- Soft delete (пометка как удалённый, но данные остаются)

### Риск 4: Некорректный API ключ при добавлении магазина
**Решение:**
- Валидация через тестовый запрос к WB API
- Показ ошибки сразу в форме

---

## 7. Definition of Done

- [ ] Клик на строку отзыва/чата → переход на детальную страницу
- [ ] Детальная страница отзыва отображает всю информацию
- [ ] Сохранение черновика ответа работает
- [ ] Отправка ответа на WB работает (реальная интеграция)
- [ ] Детальная страница чата отображает историю сообщений
- [ ] Отправка сообщения в чат работает (реальная интеграция)
- [ ] Изменение тега чата работает
- [ ] Форма "Добавить магазин" работает с валидацией
- [ ] Редактирование магазина работает
- [ ] Удаление магазина работает с подтверждением
- [ ] Toggle "Авто-рассылка" работает
- [ ] Все операции имеют loading states
- [ ] Все операции имеют toast уведомления
- [ ] Тестирование завершено

---

## 8. Приоритет

**P0** - Критически важно для полноценной работы с системой

**Статус:** Готов к реализации

**Время:** ~10-15 часов работы
