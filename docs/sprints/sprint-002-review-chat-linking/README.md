# Sprint 002 — Связка Отзыв ↔ Чат (Review-Chat Linking)

> **Статус:** Планирование
> **Старт:** 2026-02-16
> **Приоритет:** Высокий (системный прорыв)

---

## Проблема

WB API не связывает отзывы и чаты между собой.
Наша система ведёт два независимых потока данных:

- **Отзывы** — синхронизация через Feedbacks API
- **Чаты** — синхронизация через Chat API

Единственная точка пересечения — `product_nm_id` (артикул товара), но это не позволяет понять: **какой конкретно чат относится к какому отзыву**.

**Следствия:**
- Невозможно отследить полный жизненный цикл отзыва (жалоба → отклонение → чат → удаление)
- AI генерирует ответы в чате без контекста конкретного отзыва
- Нет аналитики конверсии: чат → удаление отзыва
- Нет способа автоматически связать результат переговоров с конкретным отзывом

---

## Решение

Chrome-расширение Rating5 выступает **мостом** между двумя мирами WB:

1. Расширение на странице отзывов видит контекст отзыва (nmId, rating, date, текст)
2. Кликает "Открыть чат" → WB открывает новую вкладку
3. В чате парсит **системное сообщение** WB ("Чат с покупателем по товару...")
4. Отправляет в бэкенд: `reviewContext` + `chatUrl` + `systemMessage` = **СВЯЗКА**

Это решение не использует скрытые API — только парсинг того, что WB показывает в UI.

---

## Цели спринта

### Фаза 1 — MVP (Backend API + DB)
- [ ] Новые API endpoints для расширения (получение правил, фиксация связки)
- [ ] Схема БД для хранения связки отзыв ↔ чат
- [ ] Reconciliation с существующим dialogue sync
- [ ] Идемпотентность и дедупликация

### Фаза 2 — AI Enrichment
- [ ] Передача текста отзыва в AI-контекст при генерации ответа в чате
- [ ] Автоматическое определение суммы компенсации на основе рейтинга отзыва
- [ ] Автоматическое создание auto-sequence при открытии чата

### Фаза 3 — Analytics & UI
- [ ] Полная воронка: отзыв → жалоба → чат → удаление
- [ ] Виджет отзыва в карточке чата
- [ ] Статус чата в карточке отзыва
- [ ] Дашборд конверсии

---

## Ключевое бизнес-значение

```
ДО:  Отзыв → Жалоба → Отклонена → [чёрная дыра] → ???
ПОСЛЕ: Отзыв → Жалоба → Отклонена → Чат → Предложение → Удаление
          ↓        ↓         ↓          ↓        ↓            ↓
         DB       DB        DB         DB       DB           DB
```

- **Полная прозрачность** жизненного цикла каждого отзыва
- **AI с контекстом** — знает конкретный отзыв, а не просто продукт
- **Аналитика ROI** — сколько стоит удаление отзыва через чат
- **Конкурентное преимущество** — API-only конкуренты не могут это повторить

---

## Документы спринта

| Документ | Описание | Статус |
|----------|----------|--------|
| [PRODUCT_SPEC.md](PRODUCT_SPEC.md) | Продуктовая спецификация | Готов |
| [TASK-20260216-backend-api.md](TASK-20260216-backend-api.md) | Задача на бэкенд-разработку | Готов |
| [API_CONTRACT.md](../../reference/extension-chat-api.md) | Контракт API (от команды расширения) | Внешний |
| DB_MIGRATION.md | Миграция БД | Будет создан |
| RECONCILIATION.md | Логика reconciliation sync | Будет создан |
| TESTING.md | План тестирования | Будет создан |

---

## Связанные изменения в системе

| Область | Влияние |
|---------|---------|
| **БД** | Новая таблица/колонки для связки review ↔ chat |
| **API** | 4-6 новых endpoints `/api/extension/chat/*` |
| **Dialogue Sync** | Reconciliation extension-записей с API-синхронизацией |
| **AI Flows** | Обогащение контекста текстом отзыва |
| **Cron** | Мониторинг linked chats (отзыв удалён → обновить чат) |
| **UI** | Виджет отзыва в чате, статус чата в отзыве |
| **Telegram** | Обогащённые уведомления (рейтинг, текст отзыва) |

---

## Команда

- **Расширение:** Команда Chrome Extension (отдельный репо)
- **Бэкенд + AI:** R5 SaaS (этот репо)
- **Координация:** Через API Contract + этот спринт
