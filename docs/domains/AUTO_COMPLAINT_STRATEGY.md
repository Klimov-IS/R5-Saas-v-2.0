# Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¶Ğ°Ğ»Ğ¾Ğ±

**Ğ”Ğ°Ñ‚Ğ°:** 2026-01-20
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Product Manager
**Ğ¦ĞµĞ»ÑŒ:** 100% coverage â€” Ğ½ĞµÑ‚ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° Ğ±ĞµĞ· Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸ĞºĞ° Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹

---

## ğŸ¯ Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

> "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ĞºĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ² Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°Ğ» Ğ² Ğ‘Ğ”, Ğ½Ğ° Ğ½ĞµĞ³Ğ¾ Ñ‚ÑƒÑ‚ Ğ¶Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ°ÑÑŒ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ğ°. Ğ¢Ğ¾ ĞµÑÑ‚ÑŒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñƒ Ğ½Ğ°Ñ Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ±ĞµĞ· Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸ĞºĞ¾Ğ² Ğ¶Ğ°Ğ»Ğ¾Ğ±."

---

## ğŸ“‹ Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (Gap Analysis)

### Ğ§Ñ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞµĞ¹Ñ‡Ğ°Ñ:
- âœ… CRON job ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ (production) / 5 Ğ¼Ğ¸Ğ½ (test)
- âœ… Ğ£Ğ¼Ğ½Ğ°Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· `product_rules` Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
- âœ… Batch Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· API
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» (`submit_complaints`, `complaint_rating_*`)

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:
```
10:00 â†’ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ğ·Ñ‹Ğ² 1â˜… Ğ¿Ğ¾Ğ¿Ğ°Ğ» Ğ² Ğ‘Ğ”
10:01-10:59 â†’ âŒ ĞĞ˜Ğ§Ğ•Ğ“Ğ ĞĞ• ĞŸĞ ĞĞ˜Ğ¡Ğ¥ĞĞ”Ğ˜Ğ¢
11:00 â†’ CRON Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ â†’ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñƒ
```
**GAP:** Ğ”Ğ¾ 59 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ² production!

---

## ğŸ’¡ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ“Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRIMARY: Event-Driven Generation (instant, 99% ÑĞ»ÑƒÑ‡Ğ°ĞµĞ²)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
            ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° Ğ² Ğ‘Ğ”
                        â†“
            ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° product_rules
                        â†“
                  Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹
                        â†“
                  âœ… 0 Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞµĞº

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FALLBACK: Hourly CRON (Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ, 1% ÑĞ»ÑƒÑ‡Ğ°ĞµĞ²)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
            ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ (production)
                        â†“
   Ğ˜Ñ‰ĞµÑ‚ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ±ĞµĞ· Ğ¶Ğ°Ğ»Ğ¾Ğ± (getReviewsWithoutComplaints)
                        â†“
        Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ (Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, rate limits)
```

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ³Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ñ‹Ğ¹?

1. **Event-Driven** â€” Ñ€ĞµÑˆĞ°ĞµÑ‚ 99% ÑĞ»ÑƒÑ‡Ğ°ĞµĞ² Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾
2. **CRON Fallback** â€” Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ 100% coverage Ğ´Ğ°Ğ¶Ğµ Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾ÑÑ…

---

## ğŸ›  Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

### 1. Event-Driven Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ

**Ğ“Ğ´Ğµ:** `src/app/api/stores/[storeId]/reviews/update/route.ts`

#### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ½ĞµÑ† Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ (Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²):

```typescript
// ============================================================================
// EVENT-DRIVEN COMPLAINT GENERATION
// ============================================================================

/**
 * Check if review should have a complaint generated
 */
async function shouldGenerateComplaint(review: Review, productRule: ProductRule | null): Promise<boolean> {
  // 1. Check product rule exists and complaints enabled
  if (!productRule?.submit_complaints) {
    return false;
  }

  // 2. Check specific rating is allowed
  const ratingKey = `complaint_rating_${review.rating}` as keyof ProductRule;
  if (!productRule[ratingKey]) {
    return false;
  }

  // 3. Check complaint doesn't already exist
  const existingComplaint = await dbHelpers.getComplaintByReviewId(review.id);
  if (existingComplaint) {
    return false;
  }

  // 4. Check rating is 1-4 (we don't complain about 5-star reviews)
  if (review.rating > 4) {
    return false;
  }

  return true;
}

/**
 * Generate complaints for newly synced reviews (background, non-blocking)
 */
async function autoGenerateComplaintsForNewReviews(
  storeId: string,
  newReviewIds: string[],
  apiKey: string
): Promise<void> {
  if (newReviewIds.length === 0) return;

  try {
    console.log(`[AUTO-COMPLAINT] Checking ${newReviewIds.length} new reviews for complaint generation...`);

    // Get reviews with their product rules
    const eligibleReviewIds: string[] = [];

    for (const reviewId of newReviewIds) {
      const review = await dbHelpers.getReviewById(reviewId);
      if (!review) continue;

      const productRule = await dbHelpers.getProductRule(review.product_id);
      const shouldGenerate = await shouldGenerateComplaint(review, productRule);

      if (shouldGenerate) {
        eligibleReviewIds.push(reviewId);
      }
    }

    if (eligibleReviewIds.length === 0) {
      console.log('[AUTO-COMPLAINT] No eligible reviews found for complaint generation');
      return;
    }

    console.log(`[AUTO-COMPLAINT] Found ${eligibleReviewIds.length} reviews needing complaints`);

    // Call batch generation API (non-blocking)
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:9002';
    const response = await fetch(`${baseUrl}/api/extension/stores/${storeId}/reviews/generate-complaints-batch`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ review_ids: eligibleReviewIds }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`HTTP ${response.status}: ${errorData.error || 'Unknown error'}`);
    }

    const result = await response.json();
    console.log(`[AUTO-COMPLAINT] âœ… Generated ${result.generated?.length || 0} complaints (${result.failed?.length || 0} failed)`);

  } catch (error: any) {
    console.error('[AUTO-COMPLAINT] âŒ Failed to generate complaints (will retry on CRON):', error.message);
    // Don't throw â€” CRON will pick up missed complaints later
  }
}

// ============================================================================
// INTEGRATION POINT
// ============================================================================

// AFTER syncing reviews, add this:
// Track newly created review IDs during upsert
const newReviewIds: string[] = [];

// ... (existing review upsert logic) ...
// When upserting each review, track if it's new:
const existingReview = await dbHelpers.getReviewById(wbReview.id);
if (!existingReview) {
  newReviewIds.push(wbReview.id);
}

// ... (continue with upsert) ...

// At the end, before returning response:
if (newReviewIds.length > 0) {
  // Trigger background complaint generation (don't await â€” non-blocking)
  autoGenerateComplaintsForNewReviews(storeId, newReviewIds, apiKey)
    .catch(err => {
      console.error('[AUTO-COMPLAINT] Background generation failed:', err);
    });
}
```

---

### 2. Database helper function

**Ğ“Ğ´Ğµ:** `src/db/helpers.ts`

```typescript
/**
 * Get complaint by review ID
 * Used to check if complaint already exists
 */
export async function getComplaintByReviewId(reviewId: string): Promise<ReviewComplaint | null> {
  const result = await query<ReviewComplaint>(
    'SELECT * FROM review_complaints WHERE review_id = $1',
    [reviewId]
  );
  return result.rows[0] || null;
}
```

---

### 3. CRON Fallback (ÑƒĞ¶Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!)

**Ğ“Ğ´Ğµ:** `src/lib/cron-jobs.ts:52-190`

ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ â€” hourly CRON Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ:
```typescript
// Lines 95-100
// Auto-generate complaints immediately for active products (100% automation)
console.log(`[CRON] Starting auto-complaint generation for ${store.name}...`);
const complaintStats = await generateComplaintsForStore(store.id, store.name);
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ:**
- Ğ˜Ñ‰ĞµÑ‚ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ±ĞµĞ· Ğ¶Ğ°Ğ»Ğ¾Ğ± (`getReviewsWithoutComplaints`)
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ `product_rules` (submit_complaints, complaint_rating_*)
- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ batch Ğ´Ğ¾ 50 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ·Ğ° Ñ€Ğ°Ğ·

---

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸

### Ğ›Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸:

```typescript
// Event-Driven Logs
[AUTO-COMPLAINT] Checking 15 new reviews for complaint generation...
[AUTO-COMPLAINT] Found 8 reviews needing complaints
[AUTO-COMPLAINT] âœ… Generated 8 complaints (0 failed)

// CRON Fallback Logs (hourly)
[CRON] Starting auto-complaint generation for Store A...
[CRON] Found 2 reviews needing complaints for Store A  â† Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº 0
[CRON] âœ… Generated complaints for Store A: 2 total
```

### KPI Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°:

1. **Event-Driven Coverage:**
   ```sql
   -- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¶Ğ°Ğ»Ğ¾Ğ± ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ event-driven (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ >95%)
   SELECT
     COUNT(*) FILTER (WHERE generated_at - created_at < INTERVAL '5 minutes') as event_driven,
     COUNT(*) as total,
     ROUND(100.0 * COUNT(*) FILTER (WHERE generated_at - created_at < INTERVAL '5 minutes') / COUNT(*), 2) as coverage_pct
   FROM review_complaints
   WHERE generated_at >= NOW() - INTERVAL '7 days';
   ```

2. **CRON Fallback Usage:**
   ```sql
   -- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¶Ğ°Ğ»Ğ¾Ğ± Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‡ĞµĞ½Ğ¾ CRON (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ <5%)
   SELECT
     COUNT(*) FILTER (WHERE generated_at - created_at >= INTERVAL '5 minutes') as cron_fallback,
     COUNT(*) as total
   FROM review_complaints
   WHERE generated_at >= NOW() - INTERVAL '7 days';
   ```

3. **Review Coverage (Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°):**
   ```sql
   -- ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ñ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ğ°Ğ¼Ğ¸ (Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ 100% Ğ´Ğ»Ñ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ…)
   SELECT
     COUNT(*) FILTER (WHERE rc.id IS NOT NULL) as with_complaints,
     COUNT(*) as total_eligible,
     ROUND(100.0 * COUNT(*) FILTER (WHERE rc.id IS NOT NULL) / COUNT(*), 2) as coverage_pct
   FROM reviews r
   INNER JOIN products p ON r.product_id = p.id
   INNER JOIN product_rules pr ON pr.product_id = p.id
   LEFT JOIN review_complaints rc ON rc.review_id = r.id
   WHERE p.is_active = true
     AND pr.submit_complaints = true
     AND (
       (r.rating = 1 AND pr.complaint_rating_1 = true) OR
       (r.rating = 2 AND pr.complaint_rating_2 = true) OR
       (r.rating = 3 AND pr.complaint_rating_3 = true) OR
       (r.rating = 4 AND pr.complaint_rating_4 = true)
     );
   ```

---

## âœ… Acceptance Criteria (ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ĞµĞ¼ĞºĞ¸)

### Must Have:

1. âœ… Event-Driven Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
2. âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° `product_rules` Ğ¿ĞµÑ€ĞµĞ´ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹
3. âœ… CRON fallback Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ
4. âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

### Success Metrics:

- **Event-Driven Coverage:** >95% Ğ¶Ğ°Ğ»Ğ¾Ğ± Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾
- **CRON Fallback Usage:** <5% Ğ¶Ğ°Ğ»Ğ¾Ğ± Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‡ĞµĞ½Ñ‹ CRON
- **Review Coverage:** 100% ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ¸Ğ¼ĞµÑÑ‚ Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸ĞºĞ¸ Ğ¶Ğ°Ğ»Ğ¾Ğ±
- **Latency:** ĞœĞµĞ´Ğ¸Ğ°Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ <10 ÑĞµĞºÑƒĞ½Ğ´

---

## ğŸš€ ĞŸĞ»Ğ°Ğ½ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ (MVP)

### Week 1: Event-Driven Implementation
1. âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `shouldGenerateComplaint()` Ğ² `reviews/update` route
2. âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `autoGenerateComplaintsForNewReviews()` (background)
3. âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `getComplaintByReviewId()` Ğ² db/helpers.ts
4. âœ… ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° dev Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¸

### Week 2: Monitoring & Rollout
5. âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (SQL queries Ğ²Ñ‹ÑˆĞµ)
6. âœ… Rollout Ğ½Ğ° production (10% â†’ 50% â†’ 100%)
7. âœ… ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ KPIs Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ´ĞµĞ»Ğ¸
8. âœ… Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹

---

## ğŸ›¡ Risk Mitigation (ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ€Ğ¸ÑĞºĞ¾Ğ²)

### Risk 1: ĞœĞ°ÑÑĞ¾Ğ²Ğ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² (1000+ Ğ·Ğ° Ñ€Ğ°Ğ·)

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Event-driven Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ API Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğµ.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```typescript
if (newReviewIds.length > 100) {
  console.log('[AUTO-COMPLAINT] Large batch detected, deferring to CRON');
  return; // Let CRON handle large batches
}
```

### Risk 2: AI API rate limits

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Deepseek Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ….

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² `/generate-complaints-batch`: concurrency limit + retry logic
- CRON fallback Ğ¿Ğ¾Ğ´Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ

### Risk 3: Database deadlocks

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· event-driven + CRON.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- `LEFT JOIN review_complaints` Ğ² `getReviewsWithoutComplaints()` ÑƒĞ¶Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚
- Unique constraint Ğ½Ğ° `review_complaints.review_id` Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‚Ğ¸Ñ‚ Ğ´ÑƒĞ±Ğ»Ğ¸

---

## ğŸ“š References

**Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:**
- `src/lib/cron-jobs.ts` â€” CRON fallback logic
- `src/db/helpers.ts:1842-1883` â€” getReviewsWithoutComplaints()
- `docs/complaint-auto-generation-rules.md` â€” ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- `docs/database-schema.md` â€” Schema reference

**Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:**
- `reviews` â€” Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹
- `review_complaints` â€” Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹
- `products` â€” Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ is_active
- `product_rules` â€” ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (submit_complaints, complaint_rating_*)

---

**Last Updated:** 2026-01-20
**Owner:** Product Manager
**Status:** Ready for Implementation âœ…