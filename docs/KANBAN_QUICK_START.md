# Kanban Board — Быстрый старт

**Дата:** 2026-01-22
**Обновлено:** 2026-01-22
**Статус:** ✅ Реализовано и работает

---

## ✅ Что реализовано

### 1. Документация
- ✅ [KANBAN_BOARD_IMPLEMENTATION.md](./KANBAN_BOARD_IMPLEMENTATION.md) — Полный план реализации
- ✅ [CHAT_STATUS_AND_TAGGING_SYSTEM.md](./CHAT_STATUS_AND_TAGGING_SYSTEM.md) — Product analysis
- ✅ [FILTERS_SYSTEM.md](./FILTERS_SYSTEM.md) — Система фильтров

### 2. Миграция базы данных
- ✅ Создан SQL файл: [`migrations/003_add_chat_status.sql`](../migrations/003_add_chat_status.sql)
- ✅ **ПРИМЕНЕН** в production

### 3. React компоненты
- ✅ `src/components/chats/KanbanBoardView.tsx` — Главный контейнер
- ✅ `src/components/chats/KanbanColumn.tsx` — Колонка статуса
- ✅ `src/components/chats/ChatKanbanCard.tsx` — Карточка чата
- ✅ Drag & Drop через @dnd-kit/core

---

## 🚀 Как использовать

### 1. Переключение в режим Kanban

На странице `/stores/[storeId]/chats` в тулбаре найдите кнопки переключения режимов:
- 📋 **Таблица** — классический табличный вид
- 💬 **Мессенджер** — мессенджер-подобный интерфейс
- 🎯 **Канбан** — Kanban board (новый!)

### 2. Работа с карточками

#### Drag & Drop
- Наведите на карточку чата
- Зажмите левую кнопку мыши
- Перетащите в другую колонку
- Статус чата обновится автоматически!

#### Информация на карточке
- 👤 Имя клиента
- 📦 Название товара
- 💬 Последнее сообщение (preview)
- 🕒 Время последнего обновления
- 📊 Счетчик сообщений
- 📝 Индикатор черновика (если есть)

### 3. Колонки статусов

```
┌──────────────┬──────────────┬──────────────┬──────────────┬──────────────┐
│ 📥 Входящие  │ 🔄 В работе  │ ⏳ Ожидание  │ ✅ Решено    │ 🔒 Закрыто   │
│   (inbox)    │(in_progress) │(awaiting_re..│  (resolved)  │   (closed)   │
├──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ Новые чаты   │ Работаю над  │ Жду ответа   │ Проблема     │ Диалог       │
│ от клиентов  │ ответом      │ от клиента   │ решена       │ завершен     │
└──────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
```

### 4. Фильтры

Фильтры работают во ВСЕХ режимах (Таблица, Мессенджер, Канбан):

#### Статус
- Выберите статус в тулбаре для фильтрации

#### Фильтры (новая кнопка!)
- **Последний написал:**
  - 💬 От клиента
  - 📤 От нас
  - ⚠️ Взаимоисключающие (нельзя выбрать оба)

- **С черновиком:**
  - Показать только чаты с сохраненными черновиками ответов

### 5. Массовые операции

1. Выберите чаты через чекбоксы на карточках
2. Используйте тулбар для:
   - 🤖 Массовая генерация AI ответов
   - ✈️ Массовая отправка
   - 🏷️ Массовое изменение статуса

---

## 📊 Ожидаемый результат

### До миграции:
```sql
-- chats table
id | store_id | tag          | created_at | updated_at
---|----------|--------------|------------|------------
1  | store1   | untagged     | 2026-01-20 | 2026-01-22
2  | store1   | active       | 2026-01-21 | 2026-01-22
3  | store1   | no_reply     | 2026-01-19 | 2026-01-22
```

### После миграции:
```sql
-- chats table
id | store_id | status       | tag          | status_updated_at | created_at | updated_at
---|----------|--------------|--------------|-------------------|------------|------------
1  | store1   | inbox        | untagged     | 2026-01-22        | 2026-01-20 | 2026-01-22
2  | store1   | in_progress  | active       | 2026-01-22        | 2026-01-21 | 2026-01-22
3  | store1   | awaiting_reply| no_reply    | 2026-01-22        | 2026-01-19 | 2026-01-22
```

### UI результат:
```
┌──────────┬──────────┬──────────┬──────────┬──────────┐
│📥 Входящие│🔄 В работе│⏳ Ожидание│✅ Решено │🔒 Закрыто│
│   (23)    │    (8)    │    (5)    │   (42)   │  (156)   │
│           │           │           │          │          │
│ Chat #1   │ Chat #5   │ Chat #8   │ Chat #12 │ Chat #20 │
│ Chat #2   │ Chat #6   │ Chat #9   │ Chat #13 │ Chat #21 │
│ Chat #3   │           │           │          │          │
│ [+ 20]    │ [+ 6]     │ [+ 3]     │ [+ 40]   │ [+ 154]  │
└──────────┴──────────┴──────────┴──────────┴──────────┘
       ↑ Drag & Drop между колонками
```

---

## ❓ FAQ

### Q: Что произойдет со старыми "тегами"?
**A:** Теги сохранены в поле `tag`. Это поле активно используется для AI-классификации (deletion_candidate, spam и т.д.) параллельно со статусами.

### Q: Как соотносятся `tag` и `status`?
**A:** Это два параллельных поля:
- `tag` = AI-классификация (что это за чат)
- `status` = CRM-воронка (где чат в процессе)

### Q: Как будут работать deletion workflow теги (deletion_candidate, deletion_offered, etc.)?
**A:** Они будут:
1. Сохранены в `tag`
2. Мигрированы в соответствующие статусы:
   - `deletion_candidate` → `in_progress`
   - `deletion_offered` → `awaiting_reply`
   - `deletion_agreed` → `resolved`
   - `deletion_confirmed` → `closed`

### Q: Что делать, если у меня ежедневная рассылка по 1-2 сообщения в день?
**A:** Эти чаты будут в статусе `awaiting_reply`. Каждое новое сообщение от вас будет обновлять `updated_at`, но статус останется прежним. Так вы увидите в колонке "Ожидание" все чаты, где клиент не отвечает.

---

## 🆘 Помощь

**Если возникли проблемы:**
1. Проверьте логи миграции
2. Запустите verification queries из SQL файла
3. Проверьте TypeScript типы (не должно быть ошибок компиляции)

**Контакты:**
- GitHub Issues: [R5 SaaS v2.0](https://github.com/Klimov-IS/R5-Saas-v-2.0/issues)
- Документация: `/docs` folder

---

## 🔧 Техническая информация

### Архитектура
- **Frontend:** React компоненты с TypeScript
- **Drag & Drop:** @dnd-kit/core (современная библиотека)
- **State Management:** Zustand (chatsStore)
- **Data Fetching:** React Query (кеширование, оптимизация)
- **Стилизация:** Tailwind CSS

### API Endpoints
- `GET /api/stores/[storeId]/chats` - список чатов с фильтрацией
- `PATCH /api/stores/[storeId]/chats/[chatId]/status` - изменение статуса
- `POST /api/stores/[storeId]/chats/bulk-actions` - массовые операции

### База данных
Таблица `chats`:
- `status` (ChatStatus) - текущий статус в воронке
- `status_updated_at` (timestamp) - когда статус изменился
- `tag` (ChatTag) - AI-классификация (active, deletion_candidate, spam...)

---

**Создано:** 2026-01-22
**Обновлено:** 2026-01-22
**Статус:** ✅ Реализовано и работает в production
