# Настройка Deepseek AI API для генерации жалоб

## Обзор

WB Reputation Manager использует Deepseek AI API для автоматической генерации жалоб на негативные отзывы. Эта функция требует API ключ от Deepseek.

## Где получить API ключ

1. Перейдите на сайт Deepseek: https://platform.deepseek.com
2. Зарегистрируйтесь или войдите в аккаунт
3. Перейдите в раздел API Keys: https://platform.deepseek.com/api_keys
4. Нажмите "Create API Key"
5. Скопируйте созданный ключ (начинается с `sk-`)

## Способы настройки API ключа

### Вариант 1: Через веб-интерфейс (рекомендуется)

1. Откройте приложение в браузере
2. Перейдите в раздел **Настройки** (`/settings`)
3. Найдите секцию **"Deepseek AI API"**
4. Вставьте ваш API ключ в поле ввода
5. Нажмите **"Сохранить ключ"**

API ключ будет сохранен в базу данных PostgreSQL в таблицу `user_settings`.

### Вариант 2: Через переменные окружения

1. Откройте файл `.env.local` в корне проекта
2. Найдите строку:
   ```
   DEEPSEEK_API_KEY="sk-placeholder-get-your-key-from-deepseek-com"
   ```
3. Замените placeholder на ваш реальный API ключ:
   ```
   DEEPSEEK_API_KEY="sk-ваш-реальный-ключ-здесь"
   ```
4. Перезапустите сервер:
   ```bash
   npm run dev
   ```

## Приоритет настроек

Система проверяет API ключ в следующем порядке:

1. **Настройки пользователя в БД** (`user_settings.deepseek_api_key`)
2. **Переменная окружения** (`process.env.DEEPSEEK_API_KEY`)

Если ни один из источников не предоставляет API ключ, генерация жалоб будет недоступна.

## Стоимость использования

Deepseek предлагает один из самых доступных AI API на рынке:

- **deepseek-chat**: $0.14 за 1M токенов (входящие), $0.28 за 1M токенов (исходящие)
- Бесплатный кредит при регистрации
- Одна генерация жалобы обычно использует ~500-1000 токенов (~$0.0002-0.0003 за жалобу)

## Проверка работоспособности

После настройки API ключа:

1. Откройте любой магазин с негативными отзывами (rating ≤ 3)
2. Раскройте отзыв (кликните на строку)
3. Если жалоба еще не сгенерирована, нажмите **"Сгенерировать сейчас"**
4. Система должна сгенерировать жалобу за 2-5 секунд

## Troubleshooting

### Ошибка "API ключ Deepseek не найден"

**Решение:**
- Проверьте, что API ключ сохранен в настройках (`/settings`)
- ИЛИ убедитесь, что `DEEPSEEK_API_KEY` указан в `.env.local`
- Перезапустите сервер после изменений в `.env.local`

### Ошибка "Ошибка API Deepseek: 401"

**Причины:**
- API ключ неправильный или устарел
- API ключ был удален в панели Deepseek
- API ключ был скопирован с ошибкой (должен начинаться с `sk-`)

**Решение:**
- Создайте новый API ключ на platform.deepseek.com
- Обновите ключ в настройках или `.env.local`

### Ошибка "Ошибка API Deepseek: 429"

**Причина:** Превышен лимит запросов

**Решение:**
- Подождите несколько минут
- Проверьте квоты на platform.deepseek.com
- При необходимости пополните баланс

### Кнопка "Сгенерировать сейчас" не работает

**Проверьте:**
1. Откройте консоль браузера (F12 → Console)
2. Проверьте ошибки после клика на кнопку
3. Откройте консоль сервера (терминал с `npm run dev`)
4. Проверьте логи ошибок с меткой `[API ERROR]`

## Безопасность

- **Никогда не комитьте** реальный API ключ в Git
- `.env.local` уже добавлен в `.gitignore`
- API ключ в базе данных хранится в открытом виде (для возможности использования)
- Доступ к API `/api/settings/deepseek-key` защищен авторизацией
- GET endpoint возвращает только статус наличия ключа, не сам ключ

## Дополнительная информация

- Документация Deepseek API: https://platform.deepseek.com/docs
- Цены: https://platform.deepseek.com/pricing
- Управление ключами: https://platform.deepseek.com/api_keys
