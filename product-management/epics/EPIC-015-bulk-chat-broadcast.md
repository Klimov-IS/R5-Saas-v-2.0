# EPIC-015: –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –≤ —á–∞—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π

**–°—Ç–∞—Ç—É—Å:** üìã Backlog
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–í—ã—Å–æ–∫–∏–π)
**RICE Score:** 160
**–ö–≤–∞—Ä—Ç–∞–ª:** Q2 2025 (–ê–ø—Ä–µ–ª—å - –ò—é–Ω—å)
**–û—Ü–µ–Ω–∫–∞:** 1 –Ω–µ–¥–µ–ª—è (5 SP)
**–í–ª–∞–¥–µ–ª–µ—Ü:** Product Manager

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤ —á–∞—Å—Ç–æ —Ö–æ—Ç—è—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –≤–æ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã –∏–ª–∏ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç—ã —Å —Ç–µ–≥–æ–º "active" –∏–ª–∏ —á–∞—Ç—ã –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ > 3 –¥–Ω–µ–π).

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é –≤ –∫–∞–∂–¥—ã–π —á–∞—Ç
- –ù–∞ 50 —á–∞—Ç–æ–≤ —É—Ö–æ–¥–∏—Ç 30+ –º–∏–Ω—É—Ç
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫ (–∑–∞–±—ã—Ç—å —á–∞—Ç, –æ–ø–µ—á–∞—Ç–∫–∏)

**Use Cases:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏
2. –ù–∞–ø–æ–º–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º —Å "no_reply" –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
3. –ú–∞—Å—Å–æ–≤–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ-–∫–æ–¥ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º
4. –£–≤–µ–¥–æ–º–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ —Ç–µ—Ö, –∫—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–ª

---

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∞—à–±–æ—Ä–¥–µ —á–∞—Ç–æ–≤ —Å:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ç–µ–≥–∞–º, –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å—Ç–∞—Ç—É—Å—É
- Preview –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–∫–æ–ª-–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π)
- Rate limiting –¥–ª—è WB API (–Ω–µ –±–æ–ª–µ–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É

---

## User Stories

### US-026: –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
**–ö–∞–∫:** –º–µ–Ω–µ–¥–∂–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
**–Ø —Ö–æ—á—É:** –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ –≤—Å–µ —á–∞—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—É
**–ß—Ç–æ–±—ã:** —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –º–∞—Å—Å–æ–≤—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö

**Acceptance Criteria:**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞" –≤ –¥–∞—à–±–æ—Ä–¥–µ —á–∞—Ç–æ–≤
- ‚úÖ –ú–æ–≥—É –≤—ã–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã: —Ç–µ–≥–∏, –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å—Ç–∞—Ç—É—Å
- ‚úÖ –í–∏–∂—É preview: "–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 47 —Å–æ–æ–±—â–µ–Ω–∏–π"
- ‚úÖ –ú–æ–≥—É –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ü–æ–ª—É—á–∞—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- ‚úÖ –í–∏–∂—É –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å rate limiting (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è WB API)
- ‚úÖ –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

**Story Points:** 5 SP (3-5 –¥–Ω–µ–π)

---

### US-027: –ò—Å—Ç–æ—Ä–∏—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
**–ö–∞–∫:** –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
**–Ø —Ö–æ—á—É:** –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
**–ß—Ç–æ–±—ã:** –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å, –∫–æ–º—É –∏ —á—Ç–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

**Acceptance Criteria:**
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫"
- ‚úÖ –í–∏–∂—É: –¥–∞—Ç—É, —Ç–µ–∫—Å—Ç, –∫–æ–ª-–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π, —Å—Ç–∞—Ç—É—Å (—É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∏)
- ‚úÖ –ú–æ–≥—É –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É –∏ —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
- ‚úÖ –ï—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –∏ —Å—Ç–∞—Ç—É—Å—É

**Story Points:** 2 SP (1-2 –¥–Ω—è)

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### UI Flow

```
–î–∞—à–±–æ—Ä–¥ —á–∞—Ç–æ–≤
  ‚Üì (–∫–Ω–æ–ø–∫–∞ "–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞")
–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:
  1. –í—ã–±–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤
     - –¢–µ–≥–∏: [active] [no_reply] [—É—Å–ø–µ—à–Ω—ã–π] [–Ω–µ—É—Å–ø–µ—à–Ω—ã–π]
     - –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ—Å–ª–µ–¥–Ω–∏–µ X –¥–Ω–µ–π
     - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: —Ç–æ–ª—å–∫–æ –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –ø–∏—Å–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º

  2. Preview
     "–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 47 —á–∞—Ç–æ–≤"
     [–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤]

  3. –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     [Textarea: –¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤]

  4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
     ‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
     [–û—Ç–º–µ–Ω–∞] [–û—Ç–ø—Ä–∞–≤–∏—Ç—å]

  5. –ü—Ä–æ–≥—Ä–µ—Å—Å
     –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 35/47
     [‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ñë‚ñë‚ñë] 74%
```

### Firestore Schema

```typescript
// stores/{storeId}/broadcasts/{broadcastId}
interface BroadcastCampaign {
  storeId: string;
  storeName: string;

  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  filters: {
    tags?: Array<'active' | 'no_reply' | 'successful' | 'unsuccessful'>;
    lastMessageWithinDays?: number; // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ N –¥–Ω–µ–π
    lastMessageSender?: 'user' | 'seller'; // –ö—Ç–æ –ø–∏—Å–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º
  };
  message: string; // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  totalRecipients: number; // –ö–æ–ª-–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
  sentCount: number; // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
  errorCount: number; // –û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
  status: 'pending' | 'in_progress' | 'completed' | 'failed';

  // –õ–æ–≥–∏
  chatIds: string[]; // ID —á–∞—Ç–æ–≤, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏
  errors: Array<{chatId: string, error: string}>; // –û—à–∏–±–∫–∏

  // Metadata
  createdBy: string; // UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  createdAt: Timestamp;
  completedAt?: Timestamp;
}

// stores/{storeId}/chats/{chatId}/messages/{messageId}
// –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ broadcast –ø–æ–º–µ—á–∞—é—Ç—Å—è:
interface Message {
  // ... existing fields
  isBroadcast?: boolean;
  broadcastId?: string; // –°—Å—ã–ª–∫–∞ –Ω–∞ BroadcastCampaign
}
```

### Server Action Implementation

```typescript
// src/lib/server-actions/send-broadcast.ts

'use server';

import { firestore } from '@/firebase/config';
import { sendMessageToChat } from '@/lib/wb-actions';

interface BroadcastFilters {
  tags?: string[];
  lastMessageWithinDays?: number;
  lastMessageSender?: 'user' | 'seller';
}

export async function sendBroadcastToChats(
  storeId: string,
  filters: BroadcastFilters,
  message: string
): Promise<{ success: boolean; broadcastId: string; totalSent: number }> {

  // 1. –ü–æ–ª—É—á–∞–µ–º —á–∞—Ç—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
  const chatsQuery = firestore
    .collection('stores').doc(storeId)
    .collection('chats');

  let query = chatsQuery.where('storeId', '==', storeId);

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
  if (filters.tags && filters.tags.length > 0) {
    query = query.where('tag', 'in', filters.tags);
  }

  if (filters.lastMessageWithinDays) {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - filters.lastMessageWithinDays);
    query = query.where('lastMessageDate', '>=', cutoffDate);
  }

  if (filters.lastMessageSender) {
    query = query.where('lastMessageSender', '==', filters.lastMessageSender);
  }

  const chatsSnapshot = await query.get();
  const chatIds = chatsSnapshot.docs.map(doc => doc.id);

  // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ broadcast campaign
  const broadcastRef = firestore
    .collection('stores').doc(storeId)
    .collection('broadcasts').doc();

  await broadcastRef.set({
    storeId,
    filters,
    message,
    totalRecipients: chatIds.length,
    sentCount: 0,
    errorCount: 0,
    status: 'in_progress',
    chatIds,
    errors: [],
    createdAt: new Date(),
  });

  // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å rate limiting
  const errors: Array<{chatId: string, error: string}> = [];
  let sentCount = 0;

  for (let i = 0; i < chatIds.length; i++) {
    const chatId = chatIds[i];

    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WB API
      await sendMessageToChat(storeId, chatId, message);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
      await firestore
        .collection('stores').doc(storeId)
        .collection('chats').doc(chatId)
        .collection('messages').add({
          text: message,
          sender: 'seller',
          isBroadcast: true,
          broadcastId: broadcastRef.id,
          createdAt: new Date(),
        });

      sentCount++;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
      if (i % 10 === 0) {
        await broadcastRef.update({
          sentCount,
          errorCount: errors.length,
        });
      }

    } catch (error) {
      errors.push({ chatId, error: error.message });
    }

    // Rate limiting: 10 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫ = 100ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  // 4. –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
  await broadcastRef.update({
    status: 'completed',
    sentCount,
    errorCount: errors.length,
    errors: errors.slice(0, 50), // –ü–µ—Ä–≤—ã–µ 50 –æ—à–∏–±–æ–∫
    completedAt: new Date(),
  });

  return {
    success: true,
    broadcastId: broadcastRef.id,
    totalSent: sentCount,
  };
}

// Preview: –ø–æ–¥—Å—á–µ—Ç —á–∞—Ç–æ–≤ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏
export async function previewBroadcast(
  storeId: string,
  filters: BroadcastFilters
): Promise<{ count: number; chatIds: string[] }> {

  let query = firestore
    .collection('stores').doc(storeId)
    .collection('chats')
    .where('storeId', '==', storeId);

  if (filters.tags && filters.tags.length > 0) {
    query = query.where('tag', 'in', filters.tags);
  }

  if (filters.lastMessageWithinDays) {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - filters.lastMessageWithinDays);
    query = query.where('lastMessageDate', '>=', cutoffDate);
  }

  if (filters.lastMessageSender) {
    query = query.where('lastMessageSender', '==', filters.lastMessageSender);
  }

  const snapshot = await query.get();
  const chatIds = snapshot.docs.map(doc => doc.id);

  return { count: chatIds.length, chatIds };
}
```

### UI Component

```tsx
// src/components/BroadcastModal.tsx

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { previewBroadcast, sendBroadcastToChats } from '@/lib/server-actions/send-broadcast';

export function BroadcastModal({ storeId, isOpen, onClose }: Props) {
  const [step, setStep] = useState(1); // 1: –§–∏–ª—å—Ç—Ä—ã, 2: –¢–µ–∫—Å—Ç, 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, 4: –ü—Ä–æ–≥—Ä–µ—Å—Å
  const [filters, setFilters] = useState({
    tags: [],
    lastMessageWithinDays: undefined,
    lastMessageSender: undefined,
  });
  const [message, setMessage] = useState('');
  const [preview, setPreview] = useState({ count: 0, chatIds: [] });
  const [progress, setProgress] = useState({ sent: 0, total: 0 });

  const handlePreview = async () => {
    const result = await previewBroadcast(storeId, filters);
    setPreview(result);
    setStep(2);
  };

  const handleSend = async () => {
    setStep(4);
    const result = await sendBroadcastToChats(storeId, filters, message);
    setProgress({ sent: result.totalSent, total: preview.count });
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –≤ —á–∞—Ç—ã</DialogTitle>
        </DialogHeader>

        {step === 1 && (
          <div className="space-y-4">
            <div>
              <label className="font-medium">–¢–µ–≥–∏ —á–∞—Ç–æ–≤</label>
              <div className="flex gap-2 mt-2">
                {['active', 'no_reply', 'successful', 'unsuccessful'].map(tag => (
                  <Checkbox
                    key={tag}
                    checked={filters.tags.includes(tag)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setFilters(f => ({ ...f, tags: [...f.tags, tag] }));
                      } else {
                        setFilters(f => ({ ...f, tags: f.tags.filter(t => t !== tag) }));
                      }
                    }}
                  >
                    {tag}
                  </Checkbox>
                ))}
              </div>
            </div>

            <Button onClick={handlePreview}>–î–∞–ª–µ–µ</Button>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4">
            <p className="text-lg font-medium">
              –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {preview.count} —á–∞—Ç–æ–≤
            </p>

            <Textarea
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              maxLength={1000}
              rows={6}
            />

            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setStep(1)}>–ù–∞–∑–∞–¥</Button>
              <Button onClick={() => setStep(3)} disabled={!message.trim()}>
                –î–∞–ª–µ–µ
              </Button>
            </div>
          </div>
        )}

        {step === 3 && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 p-4 rounded">
              ‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã? –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ <strong>{preview.count}</strong> —Å–æ–æ–±—â–µ–Ω–∏–π. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
            </div>

            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setStep(2)}>–û—Ç–º–µ–Ω–∞</Button>
              <Button onClick={handleSend}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</Button>
            </div>
          </div>
        )}

        {step === 4 && (
          <div className="space-y-4">
            <p>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {progress.sent} / {progress.total}</p>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className="bg-blue-600 h-2 rounded-full transition-all"
                style={{ width: `${(progress.sent / progress.total) * 100}%` }}
              />
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

**KPIs:**
- ‚è±Ô∏è –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏: 30 –º–∏–Ω/—Ä–∞—Å—Å—ã–ª–∫—É ‚Üí 2 –º–∏–Ω
- üì® –ö–æ–ª-–≤–æ –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫: > 50/–º–µ—Å—è—Ü (–Ω–∞ –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã)
- ‚úÖ Success Rate –æ—Ç–ø—Ä–∞–≤–∫–∏: > 95%
- üòä User satisfaction: +20% (–∏–∑ –æ–ø—Ä–æ—Å–æ–≤)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –ö–æ–ª-–≤–æ broadcast campaigns/–¥–µ–Ω—å
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π/—Ä–∞—Å—Å—ã–ª–∫—É
- Error rate –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–í–Ω–µ—à–Ω–∏–µ:**
- Wildberries Chat API (rate limits)
- Firestore write limits

**–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–∞—Ç–æ–≤
- `sendMessageToChat` —Ñ—É–Ω–∫—Ü–∏—è

---

## Risks & Mitigation

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| WB API rate limit ban | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | Rate limiting (100ms/—Å–æ–æ–±—â–µ–Ω–∏–µ), retry logic |
| –°–ø–∞–º-–∂–∞–ª–æ–±—ã –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ UI, –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ |
| Firestore write costs | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–æ–µ | Batch writes, –ª–∏–º–∏—Ç –Ω–∞ 500 —Å–æ–æ–±—â–µ–Ω–∏–π/—Ä–∞—Å—Å—ã–ª–∫—É |

---

## Timeline

**Week 1:**
- Day 1-2: Server Action + Firestore schema
- Day 3-4: UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ preview
- Day 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + production rollout

---

## –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

**–ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é**, –Ω–æ:
- Killer feature –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤ —Å –±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º —á–∞—Ç–æ–≤
- –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö
- –°–Ω–∏–∂–∞–µ—Ç churn –∑–∞ —Å—á–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è UX

**Value Proposition:**
- "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–º–æ-–∫–æ–¥ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –∑–∞ 2 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 30"

---

## Definition of Done

- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ preview
- ‚úÖ Server Action –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å rate limiting
- ‚úÖ Firestore schema –¥–ª—è BroadcastCampaign
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ 100+ —á–∞—Ç–∞—Ö
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–°–æ–∑–¥–∞–Ω–æ:** 30 –¥–µ–∫–∞–±—Ä—è 2024
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 30 –¥–µ–∫–∞–±—Ä—è 2024
**–°–ª–µ–¥—É—é—â–∏–π —Ä–µ–≤—å—é:** Sprint Planning Q2 2025
