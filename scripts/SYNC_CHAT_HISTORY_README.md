# üìö Chat History Sync - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

–ó–∞–≥—Ä—É–∂–∞–µ—Ç **–ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö —á–∞—Ç–æ–≤** –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∏–∑ Wildberries API:

1. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –æ—Ç WB
2. ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `chat_messages`)
4. ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —á–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é AI
5. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∞–≥–∞–∑–∏–Ω–∞

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### **–í–∞—Ä–∏–∞–Ω—Ç 1: –í —Ñ–æ–Ω–µ (–º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –Ω–æ—É—Ç–±—É–∫)**

```bash
cd "R5 saas-prod"
nohup npx tsx scripts/sync-all-chat-history.ts > logs/sync-chat-history.log 2>&1 &
```

–°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–º–æ—Ç—Ä–∏ –≤:
- **–ö–æ–Ω—Å–æ–ª—å**: `tail -f logs/sync-chat-history.log`
- **–ë–î**: `SELECT * FROM sync_logs ORDER BY started_at DESC LIMIT 10;`

---

### **–í–∞—Ä–∏–∞–Ω—Ç 2: –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–≤–∏–¥–∏—à—å –ø—Ä–æ–≥—Ä–µ—Å—Å)**

```bash
cd "R5 saas-prod"
npx tsx scripts/sync-all-chat-history.ts
```

–£–≤–∏–¥–∏—à—å live –ø—Ä–æ–≥—Ä–µ—Å—Å:
```
üöÄ Starting Chat History Sync for ALL stores...

üìä Found 5 stores to sync

[1/5] Processing: –ò–ü –¢—É—Ä–≥—É–Ω–æ–≤ –§.–§.
================================================================================
[SYNC] Starting sync for store: –ò–ü –¢—É—Ä–≥—É–Ω–æ–≤ –§.–§. (1Hjrlzp1OLfYNmgC6HQd)
================================================================================

[SYNC] Step 1: Fetching all chats from WB API...
[SYNC] ‚úÖ Found 973 chats

[SYNC] Processing batch 1/98 (chats 1-10)
  ‚úÖ [–Æ—Ä—Å–æ–ª] 12 messages synced
  ‚úÖ [–ê–Ω–∂–µ–ª–∏–∫–∞] 8 messages synced
  ...
```

---

## ‚è±Ô∏è –°–∫–æ–ª—å–∫–æ –∑–∞–π–º–µ—Ç –≤—Ä–µ–º–µ–Ω–∏

| –ú–∞–≥–∞–∑–∏–Ω–æ–≤ | –ß–∞—Ç–æ–≤ | –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è |
|-----------|-------|-----------------|
| 1         | 100   | ~1-2 –º–∏–Ω—É—Ç—ã     |
| 1         | 1000  | ~10-15 –º–∏–Ω—É—Ç    |
| 5         | 5000  | ~1 —á–∞—Å          |

**–ó–∞—â–∏—Ç–∞ –æ—Ç rate limits:**
- 500ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ —á–∞—Ç–∞–º
- 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏
- 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
- Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (3 –ø–æ–ø—ã—Ç–∫–∏)

---

## üìä –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### **1. –ß–µ—Ä–µ–∑ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ sync_logs):**

```sql
SELECT
  store_id,
  status,
  chats_total,
  chats_synced,
  messages_added,
  chats_classified,
  started_at,
  completed_at
FROM sync_logs
ORDER BY started_at DESC
LIMIT 5;
```

### **2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∞—Ç –Æ—Ä—Å–æ–ª–∞:**

```sql
SELECT COUNT(*) FROM chat_messages
WHERE chat_id = '1:e1572bda-1647-fcc3-3b4d-e7776bdc3b19';
```

**–ë—ã–ª–æ:** 0 —Å–æ–æ–±—â–µ–Ω–∏–π
**–°—Ç–∞–Ω–µ—Ç:** 12+ —Å–æ–æ–±—â–µ–Ω–∏–π ‚úÖ

---

## üõë –ö–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç

–ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ:

```bash
# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å
ps aux | grep sync-all-chat-history

# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–∑–∞–º–µ–Ω–∏ PID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
kill <PID>
```

---

## ‚ùå –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### **–û—à–∏–±–∫–∞: "WB API error 401 Unauthorized"**
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω —É –º–∞–≥–∞–∑–∏–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç —ç—Ç–æ—Ç –º–∞–≥–∞–∑–∏–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç

### **–û—à–∏–±–∫–∞: "WB API error 429 Too Many Requests"**
**–ü—Ä–∏—á–∏–Ω–∞:** Rate limit –æ—Ç WB API
**–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–µ–ª–∞–µ—Ç retry —á–µ—Ä–µ–∑ 1s ‚Üí 2s ‚Üí 4s

### **–û—à–∏–±–∫–∞: "Chat not found (404)"**
**–ü—Ä–∏—á–∏–Ω–∞:** –ß–∞—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ WB
**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç —Ç–∞–∫–æ–π —á–∞—Ç

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
scripts/
‚îú‚îÄ sync-all-chat-history.ts          # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ apply-sync-logs-migration.ts      # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
‚îî‚îÄ SYNC_CHAT_HISTORY_README.md       # –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

src/lib/
‚îî‚îÄ wb-chat-sync.ts                   # WB API helpers

migrations/
‚îî‚îÄ 20260118_create_sync_logs.sql     # SQL –º–∏–≥—Ä–∞—Ü–∏—è
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
- –í—Å–µ —á–∞—Ç—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤ –ë–î
- –í—Å–µ —á–∞—Ç—ã –±—É–¥—É—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã AI
- –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ª—é–±–æ–π —á–∞—Ç –∏ –≤–∏–¥–µ—Ç—å –≤—Å—é –ø–µ—Ä–µ–ø–∏—Å–∫—É

**–Æ—Ä—Å–æ–ª —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!** üéâ
